extends ../layout.pug

block css
    link(rel="stylesheet",href="/static/highlightstyles/default.css")

block body
    .issue-tag
        = "[" + issue.shortprojectid + "-" + ("0000" + issue.id).slice(-4) + "] ("
        if issue.isclosed
            span.issue-closed-marker Closed
        else
            span.issue-opened-marker Open
        | ) 
        if issue.assigneeid === null
            span.assigneetext No assignee
        else
            span.assigneetext="Assignee: " + issue.fullname
    h2.issue-name=issue.issuename
    hr
    .taglist
        each tag in tags
            span.tag
                = "#" + tag.tagtext + " "
                a(href="/tag/" + tag.id + "/remove") &times; 
    .underpanel
        if req.user.isadmin || issue.assigneeid === req.user.id
            if issue.isclosed
                a(href="/issues/" + issue.id + "/open") open
            else
                a(href="/issues/" + issue.id + "/close") close
            |  
        if req.user.isadmin
            a(href="/issues/" + issue.id + "/delete/areyousure") delete issue
            |  
        a(href="/issues/" + issue.id + "/posts") show posts
        br
    if req.user.id !== -1
        form(action="/issue/" + issue.id + "/assign",method="GET")
            fieldset
                legend Assign
                select(name="userid")
                    option(value="-1") Unassign
                    each user in users
                        option(value=user.id)=user.fullname
                input(type="submit",value="Assign")
        br
    if req.user.isadmin || things[0].authorid === req.user.id
        form(action="/issue/" + issue.id + "/addtag",method="GET")
            fieldset
                legend Add tag
                input(type="text",name="tagtext",placeholder="Tag name")
                input(type="submit",value="Add")
        br
        form(action="/issue/" + issue.id + "/changetitle",method="GET")
            fieldset
                legend Change title
                input(type="text",name="newtitle",placeholder="New title")
                input(type="submit", value="Change")
    ul.postlist
        each thing in things
            li.entry
                .date=thing.dateofoccurance
                span.username=thing.fullname
                |  
                if thing.data.type == "changetitle"
                    span.blue has changed the title from "
                    = thing.data.oldtitle
                    span.blue " to "
                    = thing.data.newtitle
                    span.blue "
                else if thing.data.type == "assign"
                    if (thing.data.oldassigneeid === -1 && thing.data.newassigneeid !== -1)
                        span.blue has assigned 
                        span.username=thing.newfn
                    else if (thing.data.newassigneeid !== -1 && thing.data.oldassigneeid !== -1)
                        span.blue has reassigned
                        span.username=thing.newfn
                        span.blue  from 
                        span.username=thing.oldfn
                    else if (thing.data.newassigneeid === -1 && thing.data.oldassigneeid !== -1)
                        span.blue has unassigned 
                        span.username=thing.oldfn
                else if thing.data.type == "addtag"
                    span.blue has added tag #
                    = thing.data.text
                else if thing.data.type == "deltag"
                    span.blue has removed tag #
                    = thing.data.text
                else if thing.data.type == "status"
                    span.blue has changed issue status from 
                    = thing.data.oldstatus.charAt(0).toUpperCase() + thing.data.oldstatus.slice(1)
                    span.blue  to 
                    = thing.data.newstatus.charAt(0).toUpperCase() + thing.data.newstatus.slice(1)
                else if thing.data.type == "post"
                    span.showable-container
                        a.blue.show-button.underline(href="javascript:void(0)") has posted
                        .showable
                            .postborder
                                pre
                                    code.smallmargin= thing.data.text
                else if thing.data.type == "editpost"
                    span.showable-container
                        a.blue.show-button.underline(href="javascript:void(0)") has edited
                        table.showable.hide(style="width:100%")
                            tr
                                td.postborder.fleft(style="width:48%")
                                    pre
                                        code
                                            each tv in thing.oldtext
                                                if tv[1] == ""
                                                    div.smallmargin=tv[0]
                                                else if tv[1] == "red"
                                                    div.smallmargin.beforeedit=tv[0]
                                                else if tv[1] == "filler"
                                                    div.smallmargin.filler=" "
                                br
                                td.postborder.fright(style="width:48%")
                                    pre
                                        code
                                            each tv in thing.newtext
                                                if tv[1] == ""
                                                    div.smallmargin=tv[0]
                                                else if tv[1] == "green"
                                                    div.smallmargin.afteredit=tv[0]
                                                else if tv[1] == "filler"
                                                    div.smallmargin.filler=" "
                else
                    =JSON.stringify(thing.data)
    script(src="/static/expandable.js")